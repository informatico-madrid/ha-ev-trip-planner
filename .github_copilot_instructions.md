# GitHub Copilot Instructions - EV Trip Planner

## ðŸŽ¯ Project Context

This is a **Home Assistant custom integration** for managing Electric Vehicle trip planning and charging optimization.

**Repository**: https://github.com/informatico-madrid/ha-ev-trip-planner
**Language**: Python 3.11+
**Framework**: Home Assistant Core
**License**: MIT

---

## ðŸ“‹ CODING STANDARDS - ALWAYS FOLLOW

### 1. Python Style Guide

**Mandatory tools** (run before every commit):
```bash
black custom_components/ev_trip_planner/
isort custom_components/ev_trip_planner/
pylint custom_components/ev_trip_planner/
mypy custom_components/ev_trip_planner/
```

**Key rules**:
- Line length: 88 characters (Black default)
- Type hints: REQUIRED for all public functions
- Docstrings: Google style, REQUIRED for all public functions/classes
- Imports: Standard lib â†’ Third party â†’ HA â†’ Local (use isort)
- Async: ALWAYS use `async`/`await`, never blocking calls

### 2. Import Order (STRICT)

```python
"""Module docstring first."""
from __future__ import annotations  # ALWAYS FIRST LINE

import asyncio  # Standard library
import logging
from datetime import datetime
from typing import Any

import voluptuous as vol  # Third party libraries

from homeassistant.components.sensor import SensorEntity  # HA core
from homeassistant.config_entries import ConfigEntry
from homeassistant.core import HomeAssistant
from homeassistant.helpers import config_validation as cv

from .const import DOMAIN  # Local imports LAST
from .coordinator import EVTripPlannerCoordinator
```

### 3. Logging Pattern

```python
import logging

_LOGGER = logging.getLogger(__name__)  # At module level

# Usage:
_LOGGER.debug("Detailed info: %s", variable)  # Development
_LOGGER.info("Important event: %s", event)    # User-facing
_LOGGER.warning("Warning: %s", issue)         # Potential problem
_LOGGER.error("Error: %s", error)             # Actual error
```

### 4. Type Hints (MANDATORY)

```python
from typing import Any
from homeassistant.core import HomeAssistant
from homeassistant.config_entries import ConfigEntry

async def async_setup_entry(
    hass: HomeAssistant,
    entry: ConfigEntry,
) -> bool:
    """Set up from a config entry.
    
    Args:
        hass: Home Assistant instance
        entry: Config entry for this integration
        
    Returns:
        True if setup successful
    """
    return True
```

---

## ðŸ—ï¸ ARCHITECTURE PATTERNS

### 1. Data Update Coordinator (USE THIS)

```python
from homeassistant.helpers.update_coordinator import (
    DataUpdateCoordinator,
    UpdateFailed,
)

class EVTripPlannerCoordinator(DataUpdateCoordinator):
    """Manage data updates for EV Trip Planner."""
    
    def __init__(self, hass: HomeAssistant, config: dict) -> None:
        """Initialize coordinator."""
        super().__init__(
            hass,
            _LOGGER,
            name=DOMAIN,
            update_interval=timedelta(seconds=30),
        )
    
    async def _async_update_data(self) -> dict[str, Any]:
        """Fetch latest data."""
        try:
            # Your logic here
            return data
        except Exception as err:
            raise UpdateFailed(f"Update failed: {err}") from err
```

### 2. Entity Pattern

```python
from homeassistant.helpers.update_coordinator import CoordinatorEntity

class EVTripSensor(CoordinatorEntity, SensorEntity):
    """EV Trip Planner sensor."""
    
    def __init__(
        self,
        coordinator: EVTripPlannerCoordinator,
        config_entry: ConfigEntry,
        sensor_type: str,
    ) -> None:
        """Initialize sensor."""
        super().__init__(coordinator)
        self._attr_name = f"{config_entry.data['vehicle_name']} {sensor_type}"
        self._attr_unique_id = f"{config_entry.entry_id}_{sensor_type}"
        self._sensor_type = sensor_type
    
    @property
    def native_value(self) -> Any:
        """Return sensor value."""
        return self.coordinator.data.get(self._sensor_type)
```

---

## ðŸ§ª TESTING REQUIREMENTS

### Write tests for EVERY new feature

```python
# tests/test_trip_manager.py
import pytest
from homeassistant.core import HomeAssistant

async def test_add_recurring_trip(hass: HomeAssistant, coordinator):
    """Test adding a recurring trip."""
    result = await coordinator.add_trip({
        "type": "recurrente",
        "dia_semana": "lunes",
        "hora": "09:00",
        "km": 50,
    })
    assert result is True
    assert len(coordinator.get_recurring_trips()) == 1
```

**Coverage target**: >80% for production code

**Run tests before commit**:
```bash
pytest tests/ -v --cov=custom_components/ev_trip_planner
```

---

## ðŸ“ COMMIT MESSAGES

Use **Conventional Commits**:

```bash
feat: add trip storage functionality
fix: correct deadline calculation for weekend trips
docs: update CONTRIBUTING with style guide
style: format code with black
refactor: extract trip validation to separate function
test: add tests for recurring trip expansion
chore: update dependencies
```

---

## ðŸš« WHAT NOT TO DO

### âŒ Never do this:

1. **Blocking I/O in async functions**:
```python
# âŒ WRONG
async def get_data():
    response = requests.get(url)  # Blocking!
    
# âœ… CORRECT
async def get_data():
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.json()
```

2. **Missing type hints**:
```python
# âŒ WRONG
def calculate_hours(kwh, power):
    return kwh / power
    
# âœ… CORRECT
def calculate_hours(kwh: float, power: float) -> float:
    """Calculate charging hours."""
    return kwh / power
```

3. **No docstrings**:
```python
# âŒ WRONG
def complex_function(a, b, c):
    # what does this do???
    
# âœ… CORRECT
def complex_function(a: int, b: str, c: dict) -> bool:
    """Process data and return result.
    
    Args:
        a: First parameter description
        b: Second parameter description
        c: Third parameter description
        
    Returns:
        Success status
    """
```

4. **String concatenation for logs**:
```python
# âŒ WRONG
_LOGGER.info("Processing " + str(data))

# âœ… CORRECT
_LOGGER.info("Processing %s", data)
```

---

## ðŸŽ¯ PROJECT-SPECIFIC RULES

### Trip Data Structure

```python
# Recurring trip
{
    "id": "rec_lun_trabajo",
    "tipo": "recurrente",
    "dia_semana": "lunes",  # lunes-domingo
    "hora": "09:00",
    "km": 24,
    "kwh": 3.6,
    "descripcion": "Trabajo",
    "activo": True,
}

# Punctual trip
{
    "id": "pun_20251119_avila",
    "tipo": "puntual",
    "datetime": "2025-11-19T10:30:00",  # ISO format
    "km": 110,
    "kwh": 16.5,
    "descripcion": "Ãvila",
    "estado": "pendiente",  # pendiente, completado, cancelado
}
```

### Calculation Rules

1. **kWh calculation**: `km * kwh_per_km * (1 + safety_margin/100)`
2. **Hours calculation**: `math.ceil(kwh_needed / charging_power_kw)` â† ALWAYS CEILING
3. **Deadline**: Earliest trip of the day (recurring + punctual combined)

---

## ðŸ” CODE REVIEW CHECKLIST

Before marking any task as complete, verify:

- [ ] Type hints on all public functions
- [ ] Docstrings (Google style) on all public functions/classes
- [ ] Logging uses `%s` format, not f-strings or concatenation
- [ ] All async, no blocking calls
- [ ] Imports properly ordered (run isort)
- [ ] Code formatted (run black)
- [ ] No pylint errors (run pylint)
- [ ] No mypy errors (run mypy)
- [ ] Tests written and passing
- [ ] Coverage >80% for new code

---

## ðŸ“š QUICK REFERENCE

### Common patterns to use:

```python
# Config entry data access
vehicle_name = config_entry.data[CONF_VEHICLE_NAME]

# State access
soc_state = hass.states.get(config_entry.data[CONF_SOC_SENSOR])
current_soc = float(soc_state.state) if soc_state else None

# Service call
await hass.services.async_call(
    "switch",
    "turn_on",
    {"entity_id": "switch.charger"},
    blocking=True,
)

# Coordinator data update
await coordinator.async_request_refresh()

# Translation
self.hass.localize("component.ev_trip_planner.entity.sensor.next_trip.state")
```

---

## ðŸŽ¨ FILE NAMING

- Modules: `trip_manager.py`, `coordinator.py` (snake_case)
- Classes: `EVTripPlannerCoordinator`, `TripManager` (PascalCase)
- Functions: `async_setup_entry`, `calculate_hours` (snake_case)
- Constants: `DOMAIN`, `DEFAULT_CONSUMPTION` (UPPER_SNAKE_CASE)
- Private: `_async_update_data`, `_calculate_internal` (leading underscore)

---

## ðŸš€ DEVELOPMENT WORKFLOW

1. **Create feature branch**: `git checkout -b feature/trip-storage`
2. **Write test first** (or alongside implementation)
3. **Implement feature**
4. **Run formatters and linters**
5. **Run tests**
6. **Commit with conventional commit message**
7. **Push and create PR**

---

## ðŸ“– REFERENCE INTEGRATIONS

Study these for best practices:
- **HACS**: Clean architecture, good testing
- **Adaptive Lighting**: Excellent coordinator usage
- **Spook**: Modern patterns, well-documented

---

## âš ï¸ CRITICAL REMINDERS

1. **Never break existing MPC system** until Milestone 3
2. **All modifications trackable** via git commits
3. **Test in real environment** via symbolic link
4. **Backup before Milestone 3** (modifying existing templates)
5. **Incremental releases**: v0.1, v0.2, etc.

---

**When in doubt**: Check official HA integrations in core repository for patterns.

**Priority**: Code quality > Speed. Community values well-tested, maintainable code.

---

Last updated: 18 November 2025
